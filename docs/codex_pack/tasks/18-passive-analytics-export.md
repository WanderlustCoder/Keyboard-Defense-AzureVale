---
id: passive-analytics-export
title: "Export passive deltas for analytics & docs"
priority: P2
effort: M
depends_on: [diagnostics-dashboard]
produces:
  - analytics export fields for passive unlocks/deltas
  - updated docs/analytics_schema.md entries
  - fixtures demonstrating passive analytics output
status_note: docs/status/2025-11-06_castle_passives.md
backlog_refs:
  - "#41"
  - "#79"
---
> Note: This document targets the retired web version (`apps/keyboard-defense`). The current Godot project lives at `apps/keyboard-defense-godot`; see `docs/GODOT_PROJECT.md` and `apps/keyboard-defense-godot/README.md` for active workflows.

**Context**  
Castle passive unlocks are visible in HUD/log and diagnostics, but analytics
exports don't expose passive deltas for dashboards. We need a rollup that
includes per-wave passive state plus unlock deltas.

## Steps

1. **Analytics snapshot updates**
   - Extend the analytics state to include `passiveUnlockEvents` (with `id`,
     `level`, `waveIndex`, `time`, `delta`).
   - Add running totals per wave (regen HP/s, armor, gold bonus).
2. **CLI export**
   - Update `scripts/analyticsAggregate.mjs` (and related commands) to emit the
     new fields into JSON/CSV.
   - Provide a summarized CSV (e.g., `passiveUnlockSummary.csv`) for dashboards.
3. **Fixtures & docs**
   - Create a fixture (use an existing artifact) showing the new fields.
   - Update `docs/analytics_schema.md` and `docs/codex_pack/fixtures` notes.
4. **Automation integration**
   - Modify `docs/codex_dashboard.md` (via `codex:dashboard`) to link to the new
     passive summary artifact or highlight “next passive unlock wave”.

## Implementation Detail

- **Data model**
  - Capture both the _event_ (`castlePassiveUnlocked`) and the _state_ (`passiveTotals`)
    so downstream consumers can build timelines or per-wave tables without merging
    arrays manually.
  - Normalize deltas to `{hpRegenPerSec, armor, goldBonus}` floats; avoid
    derived strings so CSV exports remain machine-friendly.
  - Include `sourceWave` + `sourceUpgradeLevel` so dashboards can correlate
    unlock cadence with tutorial progress.
- **CLI / scripting**
  - Expand `scripts/analyticsAggregate.mjs` with CLI flags:
    `--passive-summary <path>` (JSON), `--passive-summary-csv <path>`,
    and `--passive-summary-md` for the GitHub summary snippet.
  - Ensure `npm run analytics:gold` and any smoke workflows automatically write
    the passive summary artifacts into `artifacts/summaries/passive-gold*.json`.
  - Add a helper `npm run analytics:passives -- --fixture docs/codex_pack/fixtures/passives/sample.json`
    so Codex can regenerate the CSV without replaying the full game loop.

## Status

- `scripts/analyticsAggregate.mjs` now accepts `--passive-summary`, `--passive-summary-csv`, and `--passive-summary-md` so the aggregation step can emit passive unlock JSON/CSV/Markdown artifacts (CI writes them under `artifacts/summaries/passive-analytics.*`).
- Docs (`docs/analytics_schema.md`, `docs/CODEX_GUIDE.md`, `docs/CODEX_PLAYBOOKS.md`, `docs/codex_dashboard.md`) describe the new flags and where the artifacts land.
- Vitest coverage (`tests/analyticsAggregate.test.js`) exercises the new outputs.
- **Dashboards + docs**
  - Added a Codex dashboard entry describing the passive summary artifacts and regeneration commands.
  - `docs/CODEX_GUIDE.md` + `docs/CODEX_PLAYBOOKS.md` already document the CLI flags/fixtures.
  - `docs/analytics_schema.md` documents the passive fields with header order.
- **Testing**
  - Add Vitest coverage that loads historical fixtures, runs the CLI, and
    snapshots the JSON + CSV outputs (lock ordering to prevent flaky diffs).
  - Cover negative cases: waves without new passives should still emit running
    totals, and tutorials should note when no passives unlock yet.
  - Extend automation smoke tests to assert that at least one passive event is
    present and that totals stay monotonic.

## Artifacts & Outputs

- `artifacts/summaries/passive-gold.*.json|csv|md` – generated by CI + local CLI.
- Updated fixtures under `docs/codex_pack/fixtures/passives/`.
- Dashboard entry (`docs/codex_dashboard.md`) + Codex Portal pointer.
- Schema + guide updates referencing regeneration commands.
- Tests + lint updates ensuring the workflow remains reproducible.

## Acceptance criteria

- Analytics exports include passive delta data for every wave.
- Docs and fixtures describe the new structure.
- CI job summary references the passive summary artifact or key metrics.

## Verification

- npm run lint
- npm run test
- npm run codex:validate-pack
- npm run codex:validate-links
- npm run codex:status
- Run analytics CLI against a fixture to ensure passive fields populate.






